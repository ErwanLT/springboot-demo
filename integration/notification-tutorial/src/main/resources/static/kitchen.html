<!--

    Copyright (C) 2025 LE TUTOUR Erwan

    This file is part of notification-tutorial.

    notification-tutorial is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    notification-tutorial is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with notification-tutorial.  If not, see <http://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Système d'Affichage Cuisine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --col-prep-bg: #ffffff;
            --col-ready-bg: #e8f5e9;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --font-color: #333;
            --primary-color: #ff9800; /* Orange */
            --secondary-color: #4CAF50; /* Green */
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 1em;
            color: var(--font-color);
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
        }
        .kitchen-display {
            display: flex;
            gap: 1em;
        }
        .status-column {
            flex: 1;
            background-color: var(--col-prep-bg);
            border-radius: 8px;
            padding: 1em;
            box-shadow: var(--card-shadow);
        }
        .status-column.ready {
            background-color: var(--col-ready-bg);
        }
        .status-column h2 {
            text-align: center;
            border-bottom: 2px solid var(--bg-color);
            padding-bottom: 0.5em;
            margin-top: 0;
        }
        .command-card {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 1em;
            margin-bottom: 1em;
            box-shadow: var(--card-shadow);
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        .command-card.is-ready {
            border-left-color: var(--secondary-color);
        }
        .command-card h3 {
            margin: 0 0 0.5em 0;
        }
        .command-card ul {
            list-style-type: none;
            padding: 0;
            margin: 0 0 1em 0;
        }
        .command-card button {
            width: 100%;
            padding: 0.8em;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-prepare {
             background-color: var(--primary-color);
        }
        .btn-ready {
            background-color: var(--secondary-color);
        }
        .btn-complete {
            background-color: #9E9E9E; /* Grey */
        }
    </style>
</head>
<body>

<h1>Écran de Contrôle des Commandes</h1>

<div class="kitchen-display">
    <div class="status-column preparation">
        <h2>En Préparation</h2>
        <div id="col-in-preparation"></div>
    </div>
    <div class="status-column ready">
        <h2>Prêtes</h2>
        <div id="col-ready"></div>
    </div>
</div>

<script>
    const colPrep = document.getElementById('col-in-preparation');
    const colReady = document.getElementById('col-ready');

    // --- SSE Connection ---
    const eventSource = new EventSource("/notifications/subscribe");

    eventSource.onmessage = (event) => {
        const command = JSON.parse(event.data);
        renderCommand(command);
    };

    eventSource.onerror = (err) => {
        console.error("SSE Error:", err);
    };

    // --- API Functions ---
    async function fetchInitialCommands() {
        try {
            const response = await fetch('/commands');
            const commands = await response.json();
            commands.forEach(renderCommand);
        } catch (error) {
            console.error('Failed to fetch initial commands:', error);
        }
    }

    async function updateStatusCommand(id, status) {
        try {
            await fetch(`/commands/${id}/status?status=${status}`, { method: 'PUT' });
        } catch (error) {
            console.error(`Failed to update command ${id} to ${status}:`, error);
        }
    }

    // --- Rendering Logic ---
    function renderCommand(command) {
        const existingCard = document.getElementById(`cmd-${command.id}`);
        if (existingCard) {
            existingCard.remove();
        }

        if (command.status === 'COMPLETED') {
            return; // Do not display completed commands
        }

        const card = createCommandCard(command);

        if (command.status === 'READY') {
            colReady.appendChild(card);
        } else { // PENDING or IN_PREPARATION
            colPrep.appendChild(card);
            // Automatically mark PENDING as IN_PREPARATION
            if (command.status === 'PENDING') {
                updateStatusCommand(command.id, 'IN_PREPARATION');
            }
        }
    }

    function createCommandCard(command) {
        const card = document.createElement('div');
        card.id = `cmd-${command.id}`;
        card.className = 'command-card';

        const itemsHtml = command.items.map(item => `<li>- ${item}</li>`).join('');
        let buttonHtml = '';

        if (command.status === 'IN_PREPARATION') {
            card.innerHTML = `<h3>${command.customerName} (ID: ${command.id})</h3><ul>${itemsHtml}</ul>`;
            const button = document.createElement('button');
            button.className = 'btn-ready';
            button.textContent = 'Marquer comme Prête';
            button.onclick = () => updateStatusCommand(command.id, 'READY');
            card.appendChild(button);
        } else if (command.status === 'READY') {
            card.classList.add('is-ready');
            card.innerHTML = `<h3>${command.customerName} (ID: ${command.id})</h3><ul>${itemsHtml}</ul>`;
            const button = document.createElement('button');
            button.className = 'btn-complete';
            button.textContent = 'Marquer comme Terminée';
            button.onclick = () => updateStatusCommand(command.id, 'COMPLETED');
            card.appendChild(button);
        } else {
             card.innerHTML = `<h3>${command.customerName} (ID: ${command.id})</h3><ul>${itemsHtml}</ul>`;
        }

        return card;
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', fetchInitialCommands);

</script>

</body>
</html>